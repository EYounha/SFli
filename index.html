<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SFli - 스포티파이 리스너</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" type="image/png" href="data:image/png;base64,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">
</head>
<body>
    <div class="container">
        <div id="login-section" class="login-container">
            <h1 class="title">SFli</h1>
            <p class="subtitle">스포티파이 계정에 연결하여 음악 취향과 통계를 확인하세요.</p>
            <button id="login-button" class="btn">스포티파이로 로그인</button>
            <div id="error-message" class="error-message"></div>
        </div>

        <div id="loading-section" class="loading">
            <div class="spinner"></div>
            <p>로딩 중...</p>
        </div>

        <div id="logged-in-section" style="display:none;">
            <div id="user-profile" class="user-profile">
                <!-- 사용자 프로필 정보가 여기에 표시됩니다 -->
            </div>
            <button id="logout-button" class="btn btn-logout">로그아웃</button>
        </div>

        <div id="debug-panel" class="debug-panel">
            <h3>디버그 로그</h3>
            <div id="debug-log" class="debug-log"></div>
        </div>
    </div>

    <script type="module">
        import SpotifyAuth from './js/api/spotify-auth.js';
        import SpotifyClient from './js/api/spotify-client.js';

        // 엘리먼트 참조
        const loginSection = document.getElementById('login-section');
        const loadingSection = document.getElementById('loading-section');
        const loggedInSection = document.getElementById('logged-in-section');
        const userProfileSection = document.getElementById('user-profile');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const errorMessage = document.getElementById('error-message');
        const debugPanel = document.getElementById('debug-panel');
        const debugLog = document.getElementById('debug-log');

        // 디버그 모드 설정
        const isDebugMode = SpotifyAuth.isDebugMode();
        if (isDebugMode) {
            debugPanel.style.display = 'block';
            
            // 콘솔 로그 가로채기
            const originalConsoleLog = console.log;
            console.log = function(...args) {
                originalConsoleLog.apply(console, args);
                if (args[0] === '[SFli Debug]') {
                    const logMessage = args.slice(1).map(arg => 
                        typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg
                    ).join(' ');
                    
                    const logEntry = document.createElement('div');
                    logEntry.textContent = `${new Date().toLocaleTimeString()}: ${logMessage}`;
                    debugLog.appendChild(logEntry);
                    debugLog.scrollTop = debugLog.scrollHeight;
                }
            };
        }

        // 앱 초기화
        async function initApp() {
            showLoading();
            
            try {
                // Spotify 자격 증명 로드
                await SpotifyAuth.loadCredentials();
                
                // URL에서 인증 코드 확인
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const state = urlParams.get('state');
                const storedState = localStorage.getItem('spotify_auth_state');
                
                // URL에 인증 코드가 있는지 확인
                if (code) {
                    // state 검증
                    if (state === null || state !== storedState) {
                        showError('인증 상태 불일치. 보안 문제가 발생했을 수 있습니다.');
                        return;
                    }
                    
                    // 인증 코드로 토큰 요청
                    await SpotifyAuth.getAccessToken(code);
                    
                    // URL에서 인증 코드 제거 (히스토리는 유지)
                    window.history.replaceState({}, document.title, window.location.pathname + (isDebugMode ? '?debug=true' : ''));
                    
                    // 사용자 정보 로드
                    loadUserProfile();
                } else if (SpotifyAuth.isLoggedIn()) {
                    // 이미 로그인 된 상태이면 사용자 정보 로드
                    loadUserProfile();
                } else {
                    // 로그인 안 된 상태, 로그인 화면 표시
                    showLogin();
                }
            } catch (error) {
                showError('앱 초기화 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 로그인 화면 표시
        function showLogin() {
            hideLoading();
            loginSection.style.display = 'flex';
            loggedInSection.style.display = 'none';
        }

        // 로딩 화면 표시
        function showLoading() {
            loginSection.style.display = 'none';
            loggedInSection.style.display = 'none';
            loadingSection.style.display = 'flex';
        }

        // 로딩 화면 숨기기
        function hideLoading() {
            loadingSection.style.display = 'none';
        }

        // 에러 메시지 표시
        function showError(message) {
            hideLoading();
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            
            // 3초 후 에러 메시지 숨기기
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        // 스포티파이에서 사용자 프로필 정보 가져오기
        async function loadUserProfile() {
            try {
                showLoading();
                
                // 사용자 프로필 가져오기
                const profile = await SpotifyClient.getCurrentUserProfile();
                
                // 로그인 완료
                showLoggedIn(profile);
            } catch (error) {
                // 토큰 오류면 다시 로그인 시도
                if (error.message.includes('토큰')) {
                    SpotifyAuth.logout();
                    showLogin();
                }
                
                showError('사용자 정보를 가져오는데 실패했습니다: ' + error.message);
            }
        }

        // 로그인된 화면 표시
        function showLoggedIn(profile) {
            hideLoading();
            loginSection.style.display = 'none';
            loggedInSection.style.display = 'block';
            
            // 사용자 프로필 정보 표시
            const avatar = profile.images && profile.images.length > 0 
                ? profile.images[0].url 
                : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTAgMGM1LjUyMyAwIDEwIDQuNDc3IDEwIDEwcy00LjQ3NyAxMC0xMCAxMFMwIDE1LjUyMyAwIDEwIDQuNDc3IDAgMTAgMHptMCAxOGM0LjQxMiAwIDgtMy41ODggOC04cy0zLjU4OC04LTgtOC04IDMuNTg4LTggOCAzLjU4OCA4IDggOHptMC04Yy0xLjEwNSAwLTIgLjg5NS0yIDJzLjg5NSAyIDIgMiAyLS44OTUgMi0yLS44OTUtMi0yLTJ6bTAtNWMxLjY1NyAwIDMgMS4zNDMgMyAzcy0xLjM0MyAzLTMgMy0zLTEuMzQzLTMtMyAxLjM0My0zIDMtM3oiIGZpbGw9IiNhZmIxYjMiLz48L3N2Zz4=';
            
            userProfileSection.innerHTML = `
                <img src="${avatar}" alt="프로필 이미지" class="user-avatar">
                <div class="user-info">
                    <h2>${profile.display_name || '사용자'}</h2>
                    <p>${profile.email || ''}</p>
                    <p>${profile.followers ? profile.followers.total + '명의 팔로워' : ''}</p>
                </div>
            `;
            
            SpotifyAuth.debugLog('사용자 프로필 로드됨:', profile);
        }

        // 로그인 버튼 이벤트
        loginButton.addEventListener('click', async () => {
            try {
                // 스포티파이 인증 URL로 리디렉션
                const authUrl = SpotifyAuth.getAuthUrl();
                window.location.href = authUrl;
            } catch (error) {
                showError('로그인 중 오류가 발생했습니다: ' + error.message);
            }
        });

        // 로그아웃 버튼 이벤트
        logoutButton.addEventListener('click', () => {
            SpotifyAuth.logout();
            showLogin();
        });

        // 앱 초기화 실행
        initApp();
    </script>
</body>
</html>